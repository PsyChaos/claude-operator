name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  validate-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate semantic version tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Detected tag: $TAG_NAME"

          if [[ ! $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid tag format. Use vMAJOR.MINOR.PATCH"
            exit 1
          fi

          echo "✅ Tag format valid"

      - name: Ensure required files exist
        run: |
          test -f operator.sh || (echo "operator.sh missing" && exit 1)
          test -f Makefile || (echo "Makefile missing" && exit 1)
          test -f install.sh || (echo "install.sh missing" && exit 1)
          test -f README.md || (echo "README.md missing" && exit 1)
          echo "✅ Required files present"

      - name: Stamp version into operator.sh
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          sed -i "s/^OPERATOR_VERSION=.*/OPERATOR_VERSION=\"$TAG_NAME\"/" operator.sh
          grep "OPERATOR_VERSION=" operator.sh
          echo "✅ Version stamped: $TAG_NAME"

      - name: Import GPG signing key
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d | gpg --batch --import
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -1)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
          echo "Signing key imported: $GPG_KEY_ID"
          # Configure GPG for non-interactive/CI use
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye || true

      - name: Generate checksums
        run: |
          sha256sum operator.sh > operator.sh.sha256
          sha256sum install.sh > install.sh.sha256
          mkdir -p profiles
          for f in profiles/*.md; do
            sha256sum "$f" > "$f.sha256"
          done

      - name: Generate GPG signatures
        run: |
          for f in operator.sh install.sh profiles/*.md; do
            gpg --batch --yes --pinentry-mode loopback \
                --detach-sign --armor --local-user "$GPG_KEY_ID" "$f"
          done
          echo "✅ Signatures generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            operator.sh
            install.sh
            operator.sh.sha256
            install.sh.sha256
            operator.sh.sig
            install.sh.sig
            profiles/elite.md
            profiles/elite.md.sha256
            profiles/elite.md.sig
            profiles/high-autonomy.md
            profiles/high-autonomy.md.sha256
            profiles/high-autonomy.md.sig
            profiles/memory-centric.md
            profiles/memory-centric.md.sha256
            profiles/memory-centric.md.sig
            profiles/senior-production.md
            profiles/senior-production.md.sha256
            profiles/senior-production.md.sig
            profiles/token-optimization.md
            profiles/token-optimization.md.sha256
            profiles/token-optimization.md.sig
            claude-operator.gpg.pub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
